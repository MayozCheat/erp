# 工程公司财务管理系统：项目结构、模块划分与数据库设计草案（MySQL + 后端优先）

> 当前共识：先做后端（纯 C/C++），前端后续再接入。  
> 技术约束：后端核心语言 C/C++、数据库使用 MySQL、Web 前端后续对接账号登录与权限展示。



## 0. 开发总原则（新增，作为后续实现强约束）

为了匹配你的开发习惯与学习节奏，后续所有代码实现统一遵守：

1. **不使用 CMake**：统一使用 `Makefile`（Linux）作为默认构建入口。
2. **面向对象 + 分层分文件**：每个类单独头/源文件，按模块目录管理，避免“一个文件写全部”。
3. **中文优先可读性**：
   - 关键业务逻辑、函数说明、流程节点使用中文注释；
   - 终端 `cout` 提示尽量中文（例如“登录成功”“权限不足”）。
4. **新手友好**：
   - 每个模块保留 `README-模块说明.md`；
   - 关键流程提供“调用顺序说明”和最小示例；
   - 错误信息尽量可定位（含模块名、函数名、参数摘要）。
5. **背景不遗忘机制**：将“项目背景与约束”固化到仓库文档和模板中，避免后续偏离。

---

## 1. 总体架构建议（按你新要求调整）

采用 **后端优先 + 权限先行** 的方式：

- **后端 API（C/C++）**：先完成认证授权、公司/项目/财务数据管理、报表导出接口。
- **数据层（MySQL）**：替代 SQLite，适配“公司多、项目多、并发高”的场景。
- **前端（后续阶段）**：根据账号权限仅展示可访问公司数据。

建议架构风格：

1. 后端采用 Controller → Service → Repository 分层；
2. 权限在 Service 层和 SQL 过滤双重校验（避免越权读写）；
3. 预留前端对接接口：登录、公司列表、数据分页、导入导出任务。

### 1.1 关于你当前技术能力的落地策略（新增）

你补充了“主要会控制台程序、MFC 不熟练”的情况，因此项目方案新增两种路径：

- **路径 A：后端采用常规 C/C++ Web 服务（推荐）**
  - 需要两个网页入口：
    1. **业务操作端**：公司/项目/财务录入与查询
    2. **管理后台端**：账号、权限、公司授权、数据库运维辅助
  - 优点：职责清晰、维护简单、后续扩展方便。

- **路径 B：后端采用 MFC 承载部分服务能力（不推荐作为首版）**
  - 你设想里可以仅保留一个业务网页给终端用户；
  - 但账号权限与数据库管理能力仍需要工具界面（可先用后端命令行工具替代，不强依赖 MFC 复杂控件）。
  - 风险：MFC 学习与 UI 控件调试成本高，不利于快速推进后端主链路。

> 结论：首版建议走路径 A（纯 C/C++ 后端 + 双网页分工），优先交付认证授权与财务 API；MFC 可作为后续内部运维工具选项。

---

## 2. 项目目录结构草案（后端先落地）

```text
erp-finance-system/
├─ README.md
├─ docs/
│  ├─ architecture/
│  │  ├─ system-overview.md
│  │  ├─ module-boundary.md
│  │  └─ permission-model.md
│  ├─ db/
│  │  ├─ erd.md
│  │  ├─ mysql-schema-draft.sql
│  │  └─ migration-plan.md
│  └─ api/
│     ├─ auth-api.md
│     ├─ company-api.md
│     └─ finance-api.md
├─ backend/
│  ├─ Makefile
│  ├─ src/
│  │  ├─ main.cpp
│  │  ├─ controller/
│  │  │  ├─ auth_controller.cpp
│  │  │  ├─ company_controller.cpp
│  │  │  ├─ project_controller.cpp
│  │  │  └─ finance_controller.cpp
│  │  ├─ service/
│  │  │  ├─ auth_service.cpp
│  │  │  ├─ permission_service.cpp
│  │  │  ├─ company_service.cpp
│  │  │  └─ finance_service.cpp
│  │  ├─ repository/
│  │  │  ├─ user_repo.cpp
│  │  │  ├─ permission_repo.cpp
│  │  │  ├─ company_repo.cpp
│  │  │  └─ finance_repo.cpp
│  │  ├─ domain/
│  │  ├─ dto/
│  │  ├─ middleware/
│  │  │  ├─ auth_middleware.cpp
│  │  │  └─ acl_middleware.cpp
│  │  └─ utils/
│  ├─ include/
│  ├─ tests/
│  └─ third_party/
├─ database/
│  ├─ migrations/
│  ├─ seed/
│  └─ mysql/
│     └─ init.sql
└─ scripts/
   ├─ dev-start.sh
   ├─ init-db.sh
   └─ backup-db.sh
```

> 如果后续你决定加 MFC 工具端，可额外增加：

```text
├─ tools/
│  └─ mfc-admin/
│     ├─ MfcAdmin.sln
│     └─ src/
```

该目录用于“内部管理工具”（例如账号初始化、权限批量配置、数据库巡检），不与 Web 业务端耦合。

---

## 3. 模块划分（聚焦你强调的权限能力）

### 3.1 认证与账号模块（新增优先级：最高）

- 账号创建、重置密码、禁用账号
- 密码安全：哈希存储（bcrypt/argon2）
- 登录会话：JWT 或服务端 Session（二选一）

### 3.2 权限控制模块（核心）

支持你描述的 3 类能力：

1. **公司级访问控制**：没有 A 公司权限就看不到 A 公司任何数据。
2. **读写分离权限**：
   - 可给用户 A 公司只读权限（read）
   - 可给用户 B 公司读写权限（read + write）
3. **多公司组合授权**：用户可同时拥有 A/C/D 公司权限，只展示 A/C/D 数据。

### 3.3 公司管理模块

- 公司基础信息管理
- 仅管理员或有该公司 write 权限的用户可修改

### 3.4 项目管理模块

- 项目立项、状态流转、负责人、合同金额
- 查询时自动按公司权限过滤

### 3.5 财务模块

- 成本明细
- 营收明细
- 税金明细
- 利润汇总（项目维度、公司维度）

### 3.6 Excel 导入导出模块

- 导入：项目、成本、营收、税金
- 导出：查询结果、利润汇总
- 导入时执行公司权限校验（不能导入无权限公司的数据）

---

## 4. 后端分层建议（纯 C/C++）

### 4.1 Controller

- 解析请求、返回响应
- 不放复杂业务逻辑

### 4.2 Service

- 认证（密码验证、token 生成）
- 授权（公司级 read/write 检查）
- 财务计算（收入/成本/税金/利润）

### 4.3 Repository

- 负责 MySQL CRUD
- 参数化 SQL，避免注入
- 关键查询默认附加 `company_id` 权限过滤

### 4.4 Middleware

- 登录态校验
- 路由权限校验
- 数据权限上下文注入（把当前用户可访问 company_id 列表注入请求上下文）

---

## 5. 数据库模型（MySQL）初步设计

## 5.1 核心业务表

### A. companies

- id (PK)
- company_code (UNIQUE)
- name
- tax_identification_no
- address
- contact_person
- contact_phone
- is_active
- created_at
- updated_at

### B. projects

- id (PK)
- company_id (FK -> companies.id)
- project_code (UNIQUE)
- project_name
- project_manager
- contract_amount DECIMAL(18,2)
- start_date
- planned_end_date
- actual_end_date
- status
- created_at
- updated_at

### C. cost_categories

- id (PK)
- category_code (UNIQUE)
- category_name
- is_tax_deductible
- remark

### D. cost_entries

- id (PK)
- company_id (FK -> companies.id)  # 冗余字段，便于权限与查询性能
- project_id (FK -> projects.id)
- category_id (FK -> cost_categories.id)
- cost_date
- amount DECIMAL(18,2)
- vendor_name
- invoice_no
- description
- settlement_status
- created_at
- updated_at

### E. revenue_entries

- id (PK)
- company_id (FK -> companies.id)
- project_id (FK -> projects.id)
- revenue_date
- amount_excluding_tax DECIMAL(18,2)
- tax_rate DECIMAL(5,2)
- tax_amount DECIMAL(18,2)
- amount_including_tax DECIMAL(18,2)
- invoice_no
- payment_received_amount DECIMAL(18,2)
- payment_received_date
- receivable_status
- created_at
- updated_at

### F. tax_entries

- id (PK)
- company_id (FK -> companies.id)
- project_id (FK -> projects.id)
- tax_type
- tax_period
- tax_base_amount DECIMAL(18,2)
- tax_rate DECIMAL(5,2)
- tax_amount DECIMAL(18,2)
- declared_amount DECIMAL(18,2)
- paid_amount DECIMAL(18,2)
- paid_date
- created_at
- updated_at

### G. profit_snapshots（可选）

- id (PK)
- company_id (FK -> companies.id)
- project_id (FK -> projects.id, nullable)
- snapshot_period
- total_revenue DECIMAL(18,2)
- total_cost DECIMAL(18,2)
- total_tax DECIMAL(18,2)
- total_profit DECIMAL(18,2)
- calculated_at

### H. import_export_jobs

- id (PK)
- company_id (FK -> companies.id, nullable)
- job_type (IMPORT/EXPORT)
- data_type
- file_name
- file_path
- status
- total_rows
- success_rows
- failed_rows
- error_report_path
- created_by (FK -> users.id)
- created_at
- finished_at

---

## 5.2 认证授权表（新增）

### I. users

- id (PK)
- username (UNIQUE)
- password_hash
- display_name
- is_super_admin
- is_active
- last_login_at
- created_at
- updated_at

### J. roles

- id (PK)
- role_code (UNIQUE)
- role_name
- description

### K. permissions

- id (PK)
- perm_code (UNIQUE)  # e.g. company.read / company.write / finance.read / finance.write
- perm_name
- description

### L. user_roles

- user_id (FK -> users.id)
- role_id (FK -> roles.id)
- UNIQUE(user_id, role_id)

### M. role_permissions

- role_id (FK -> roles.id)
- permission_id (FK -> permissions.id)
- UNIQUE(role_id, permission_id)

### N. user_company_permissions（关键表）

- id (PK)
- user_id (FK -> users.id)
- company_id (FK -> companies.id)
- can_read BOOLEAN
- can_write BOOLEAN
- created_at
- updated_at
- UNIQUE(user_id, company_id)

> 该表直接实现你提出的规则：
> - A 公司无记录 => 看不到 A
> - can_read=1, can_write=0 => 只读
> - 可同时给同一用户配置多家公司（A/C/D）

---

## 5.3 关键索引建议

- projects(company_id, status)
- cost_entries(company_id, project_id, cost_date)
- revenue_entries(company_id, project_id, revenue_date)
- tax_entries(company_id, project_id, tax_period)
- user_company_permissions(user_id, company_id)
- users(username)

---

## 6. 权限判定规则（落地口径）

### 6.1 查询类接口

- 必须登录
- 根据 user_company_permissions 取出可读 company_id 集合
- SQL 自动附加 `company_id IN (...)`

### 6.2 写入类接口

- 必须登录
- 目标 company_id 必须满足 `can_write=1`
- 若只读或无授权，返回 403

### 6.3 超级管理员

- `is_super_admin=1` 可跨公司全量访问
- 普通账号只能看到授权公司

---

## 7. API 草案（后端第一阶段必须有）

### 7.1 认证

- `POST /api/auth/login`
- `POST /api/auth/logout`
- `POST /api/auth/reset-password`

### 7.2 账号与权限管理

- `POST /api/admin/users`（创建账号）
- `PUT /api/admin/users/{id}/status`（启用/禁用）
- `POST /api/admin/users/{id}/company-permissions`（配置公司读写权限）
- `GET /api/admin/users/{id}/company-permissions`

### 7.3 业务数据

- 公司、项目、成本、营收、税金 CRUD
- 利润汇总查询
- Excel 导入导出任务接口

### 7.4 管理端能力接口（对应“额外网页管理端”）

- `POST /api/admin/companies`（创建公司）
- `PUT /api/admin/companies/{id}`（修改公司）
- `POST /api/admin/permissions/batch-grant`（批量授权）
- `POST /api/admin/system/init-super-admin`（初始化超级管理员，仅首次启用）
- `GET /api/admin/audit-logs`（操作审计日志）

---

## 8. 里程碑（改为“后端先行”）

- M1：MySQL schema + migration + seed（含 users/permissions/company 权限表）
- M2：认证登录 + 账号管理 + 公司级读写权限控制
- M3：公司/项目/成本/营收/税金 API（全部接入权限拦截）
- M4：利润汇总与 Excel 导入导出 API
- M5：前端接入（业务端 + 管理端），登录后按公司权限展示

---

## 9. 前端形态选择说明（新增）

### 9.1 如果“后端不使用 MFC”（推荐）

- 建议前端拆成两个页面（可同一站点不同路由）：
  1. `/app`：业务人员页面（仅显示授权公司数据）
  2. `/admin`：管理员页面（账号、权限、公司、审计）

### 9.2 如果“后端使用 MFC”

- 对外业务可保留一个网页页面；
- 管理动作可先放 MFC/控制台工具中执行；
- 但为了后续可维护性，仍建议最终补齐 Web 管理端。

---



## 10. 后端代码规范（实施阶段必须遵守）

### 10.1 目录与命名

- 一个类对应一对文件：`xxx_service.h/.cpp`、`xxx_controller.h/.cpp`
- 按职责分类目录：`controller/`、`service/`、`repository/`、`domain/`、`utils/`
- 命名统一：类名 PascalCase，函数名 camelCase，常量全大写+下划线

### 10.2 面向对象设计约束

- Controller 只做参数接收与响应封装
- Service 只写业务规则和权限判定
- Repository 只负责数据库访问
- 禁止跨层直连（如 Controller 直接写 SQL）

### 10.3 注释与日志规范（中文）

- 每个公开类/函数要有中文用途说明
- 复杂逻辑分段写中文注释（输入、处理、输出）
- 终端提示统一中文：成功、失败、权限不足、参数错误、数据库异常

### 10.4 给“代码能力不强”场景的保障

- 每个模块配套“最小可运行样例”
- 每个 API 都给请求/响应示例
- 每次新增功能同时补一段“如何调试”说明

---

## 11. 项目背景固化清单（防止后续遗忘）

后续每次开发前先对照以下背景：

- 行业：工程公司财务管理
- 技术主线：后端纯 C/C++ + MySQL
- 构建方式：Makefile（不使用 CMake）
- 权限模型：账号密码登录 + 公司级读写权限 + 多公司可见性过滤
- 用户特点：开发者以控制台经验为主，需要高可读、高注释、可分步理解的实现

建议在仓库根目录增加以下文件并长期维护：

1. `PROJECT_CONTEXT.md`：项目背景与不可变约束
2. `CODING_RULES_ZH.md`：中文注释与代码风格强约束
3. `DEVELOPMENT_PLAYBOOK.md`：从编译到调试的步骤手册

---

## 12. 立即可执行的下一步（如果你确认）


我下一步会按“最高权限程序员、后端先写”的方式，直接给你初始化：

1. Makefile 工程骨架（纯 C/C++，不使用 CMake）
2. MySQL 初始化 SQL（含权限模型）
3. 认证与权限中间件占位代码
4. 公司/项目/财务模块 REST 路由骨架
5. Excel 导入导出任务接口骨架（先定义协议，再逐步实现）

> 你只要回复“确认开始”，我就进入代码阶段，从后端基础骨架开始写。
